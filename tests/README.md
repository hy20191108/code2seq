# code2seq テストファイル

## 概要

このテストファイルは `flask_app.py` が正しく動作し、期待されるベクトルデータ（単語ベクトル、ASTパスベクトル、PathContextベクトル）を出力するかを検証します。

## テストファイル

### `test_flask_app.py`

code2seqの動作チェック用メインテストファイルです。

## 実行方法

```bash
# code2seqディレクトリで実行
rye run python tests/test_flask_app.py
```

## テスト内容

### 1. 基本機能テスト
- `predictor.get()` メソッドが正常に実行されるか
- 結果が期待される型（list）で返されるか

### 2. データ構造検証テスト
- 返されるデータが `list[tuple(method_name, method_vector, path_contexts)]` 形式か
- 各メソッドデータが3つの要素（メソッド名、メソッドベクトル、パスコンテキストリスト）を含むか
- パスコンテキストが辞書形式で必須キーを含むか

### 3. ベクトル品質テスト
- メソッドベクトルが期待される値（-1）を返すか
- パスコンテキストの以下4種類のベクトルが適切に設定されているか：
  - `vector`: パスコンテキストベクトル（256次元）
  - `source_vector`: ソース単語ベクトル（128次元）
  - `target_vector`: ターゲット単語ベクトル（128次元）
  - `astpath_vector`: ASTパスベクトル（128次元）

### 4. Pickleシリアライゼーションテスト
- 結果がpickleで正しくシリアライズ・デシリアライズできるか
- flask_app.pyでのレスポンス形式と互換性があるか

## 期待される結果

正常に動作する場合、以下のような出力が得られます：

```
code2seq flask_app.py 動作チェックテスト開始

=== 基本動作テスト ===
✅ predictor.get()の実行成功
   結果の型: <class 'list'>
   結果の長さ: 1

=== データ構造検証テスト ===
✅ メソッド数: 1
  メソッド0: add
    メソッドベクトル型: <class 'int'>
    パスコンテキスト数: 55
    メソッドベクトル: -1 (仕様通り)

  --- パスコンテキスト詳細チェック ---
    パスコンテキスト0:
      source: int (型: <class 'str'>)
      target: METHOD_NAME (型: <class 'str'>)
      path: Prim0|Mth|Nm1... (型: <class 'str'>)
      attention: 0.006675346754491329 (型: <class 'float'>)
      ✅ vector: shape=(256,), 非ゼロ要素数=256
      ⚠️ source_vector: None (詳細チェックでは一部None)
      ⚠️ target_vector: None
      ⚠️ astpath_vector: None

=== ベクトル品質テスト ===
✅ メソッドベクトル: -1 (仕様通り)
パスコンテキスト総数: 62
  vector: 非ゼロ=62, ゼロ=0
    ✅ vectorに有効なデータが存在
  source_vector: 非ゼロ=62, ゼロ=0
    ✅ source_vectorに有効なデータが存在
  target_vector: 非ゼロ=62, ゼロ=0
    ✅ target_vectorに有効なデータが存在
  astpath_vector: 非ゼロ=62, ゼロ=0
    ✅ astpath_vectorに有効なデータが存在

=== Pickleシリアライゼーションテスト ===
✅ シリアライズ成功: 36427 bytes
✅ デシリアライズ成功
✅ シリアライゼーション整合性確認完了

==================================================
テスト結果サマリー
==================================================
基本機能: ✅ PASS
データ構造: ✅ PASS
ベクトル品質: ✅ PASS
Pickleシリアライゼーション: ✅ PASS

合計: 4/4 テスト通過
🎉 すべてのテストが成功しました！
```

## トラブルシューティング

### よくある問題

1. **TensorFlowの警告**: TensorFlow 1.15では多くの警告が出力されますが、動作には影響しません
2. **型エラー**: Python 3.7環境で型注釈のないライブラリを使用するため、型チェックエラーが発生しますが、実行には問題ありません
3. **メモリ不足**: 大きなモデルを読み込むため、十分なメモリが必要です

### エラーの意味

- `❌ FAIL`: そのテストが失敗
- `⚠️`: 警告（問題の可能性があるが、必ずしも致命的ではない）
- `✅ PASS`: テストが成功

### 重要なチェックポイント

1. **メソッドベクトル**: interactive_predict.pyの仕様により-1を返します（正常動作）
2. **ベクトル次元**: パスコンテキストベクトルは256次元、単語・ASTパスベクトルは128次元
3. **None値**: 詳細チェックで一部Noneが表示されることがありますが、品質テストで全体的には有効なデータが存在することを確認
4. **辞書構造**: パスコンテキストが辞書形式で必須キーを含んでいるかを確認
5. **pickle互換性**: flask_app.pyでのレスポンス形式との互換性を確認

## 依存関係

- TensorFlow 1.15.0
- numpy 1.18.5
- Python >= 3.7
- code2seqの学習済みモデル 